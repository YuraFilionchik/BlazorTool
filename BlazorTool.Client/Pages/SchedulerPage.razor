@page "/scheduler"

@using System.Linq
@using BlazorTool.Client.Models
@using BlazorTool.Client.Services
@using BlazorTool.Client.Components
@using System.Text
@using System.Diagnostics
@using Telerik.Blazor.Components
@using Telerik.Blazor.Components.Scheduler
@using Telerik.DataSource.Extensions
@inject IJSRuntime JSRuntime

@inject ApiServiceClient apiService

@cellStyles
<h3>Scheduler</h3>

<div style="display:flex; gap:1rem;">
    <div style="flex:2;">
        <TelerikScheduler TItem="SchedulerAppointment"
                          Id="Scheduler1"
                          Data="@Appointments"
                          @ref="SchedulerRef"
                          @bind-Date="SchedulerDate"
                          @bind-View="CurrentView"
                          AllowCreate="true"
                          AllowUpdate="true"
                          AllowDelete="true"
                          OnCreate="@OnCreateAppointment"
                          OnUpdate="@OnUpdateAppointment"
                          OnDelete="@OnDeleteAppointment"
                          IdField="Id"
                          StartField="Start"
                          EndField="End"
                          TitleField="Title"
                          DescriptionField="Description"
                          IsAllDayField="IsAllDay">

            <SchedulerViews>
                <SchedulerDayView StartTime="@DayStart" EndTime="@DayEnd" />
                <SchedulerWeekView StartTime="@DayStart" EndTime="@DayEnd" />
                <SchedulerMonthView />
            </SchedulerViews>
        </TelerikScheduler>
    </div>

    <div style="flex:1;">
        @if (isLoading)
        {
            <p>Loading orders…</p>
        }
        else
        {
            <TelerikTooltip TargetSelector=".tooltip-target" Width="300px"/>
            <TelerikGrid TItem="WorkOrder"
                         Data="@UntakenOrders"
                         RowDraggable="true"
                         OnRowDrop="@GridRowDrop"
                         Sortable="true"
                         
            >

                <RowTemplate Context="order">
                    <td class="tooltip-target" title="@order.WODesc">@order?.AssetNo</td>
                    <td class="tooltip-target" title="@order.WODesc">@order?.WOCategory</td>
                    <td class="tooltip-target" title="@order.WODesc">@order?.DeviceCategory</td>
                    <td class="state-@order?.StateColor?.TrimStart('#') tooltip-target" title="@order?.WODesc">@order?.WOState</td>
                </RowTemplate>

                <GridSettings>
                    <GridRowDraggableSettings DragClueField="@nameof(WorkOrder.WorkOrderID)" />
                </GridSettings>
                
                
                <GridColumns>
                    <GridColumn Field="@nameof(WorkOrder.AssetNo)" Title="Asset No" />
                    <GridColumn Field="@nameof(WorkOrder.WOCategory)"/>
                    <GridColumn Field="@nameof(WorkOrder.DeviceCategory)" Title="Start Date" />
                    <GridColumn Field="@nameof(WorkOrder.WOState)" />
                </GridColumns>

            </TelerikGrid>
        }
    </div>
</div>

<TelerikWindow @bind-Visible="@isOrderCardOpen" 
                  
                   Modal="true">
        <WindowTitle>
        </WindowTitle>
        <WindowContent>
             <WorkOrderComponent WorkOrderId="@selectedOrder.WorkOrderID" WorkOrder="@selectedOrder" />
        </WindowContent>
        <WindowActions>
            <WindowAction Name="Close" />
        </WindowActions>
        <WindowFooter>
        </WindowFooter>
    </TelerikWindow>

@code {

    private List<SchedulerAppointment> Appointments { get; set; } = new();
    private TelerikScheduler<SchedulerAppointment>? SchedulerRef { get; set; }

    private DateTime SchedulerDate { get; set; } = DateTime.Today;
    private SchedulerView CurrentView { get; set; } = SchedulerView.Month;
    private DateTime DayStart => DateTime.Today.AddHours(8);
    private DateTime DayEnd => DateTime.Today.AddHours(18);
    private MarkupString cellStyles = new MarkupString(); //for rows colors
    private List<WorkOrder> UntakenOrders { get; set; } = new();
    private List<WorkOrder> TakenOrders { get; set; } = new();
    private List<WorkOrder> _allOrders = new();
    private bool isLoading { get; set; } = true;
    private bool isOrderCardOpen { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        var isWASM = JSRuntime is IJSInProcessRuntime;
        Debug.Print($"--- OnInitializedAsync. WASM = {isWASM}");
            await LoadData();
        // if (isWASM)
        // {
        //     // Load data only in WASM mode to avoid double loading in prerendering
        //     await LoadData();
        // }
        // else
        // {
        //     // In server-side mode, we can skip loading data here
        //     await LoadData();
        // } 
    }

    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();
        _allOrders = await apiService.GetWorkOrdersCachedAsync(); // Nie rozpoczete zlecenia
        UntakenOrders = _allOrders.Where(x => x.TakeDate == null).ToList();
        TakenOrders = _allOrders.Where(x => x.TakeDate != null).ToList();
        cellStyles = RenderStatesStyle(_allOrders);
        Appointments = TakenOrders.Select(o => new SchedulerAppointment(o)).ToList();
        isLoading = false;
        StateHasChanged();

    }

    // ==== DragAndDrop from Grid to Scheduler ====
    private Task GridRowDrop(GridRowDropEventArgs<WorkOrder> args)
    {
        if (args.DestinationComponentId == "Scheduler1" && SchedulerRef != null)
        {
            var slot = SchedulerRef.GetTimeSlotFromDropIndex(args.DestinationIndex);
            foreach (var wo in args.Items)
            {
                Appointments.Add(new SchedulerAppointment
                {
                    Id = wo.WorkOrderID.ToString(),
                    Title = wo.AssetNo ?? $"WO {wo.WorkOrderID}",
                    Start = slot.Start,
                    End = slot.End,
                    IsAllDay = slot.IsAllDay,
                    Description = wo.WODesc ?? string.Empty
                });
            }
            SchedulerRef.Rebind();
        }
        return Task.CompletedTask;
    }

    // ==== Scheduler CUD handlers ====
    private Task OnCreateAppointment(SchedulerCreateEventArgs args)
    {
        if (args.Item is SchedulerAppointment newAppt && SchedulerRef != null)
        {
            Appointments.Add(newAppt);
            SchedulerRef.Rebind();
        }
        return Task.CompletedTask;
    }

    private Task OnUpdateAppointment(SchedulerUpdateEventArgs args)
    {
        if (args.Item is SchedulerAppointment updAppt)
        {
            var ex = Appointments.FirstOrDefault(a => a.Id == updAppt.Id);
            if (ex != null)
            {
                ex.Title = updAppt.Title;
                ex.Start = updAppt.Start;
                ex.End = updAppt.End;
                ex.Description = updAppt.Description;
                ex.IsAllDay = updAppt.IsAllDay;
                SchedulerRef?.Rebind();
            }
        }
        return Task.CompletedTask;
    }

    private Task OnDeleteAppointment(SchedulerDeleteEventArgs args)
    {
        if (args.Item is SchedulerAppointment delAppt)
        {
            Appointments.RemoveAll(a => a.Id == delAppt.Id);
            SchedulerRef?.Rebind();
        }
        return Task.CompletedTask;
    }



    #region Grid Row Styles
    void OnRowRenderHandler(GridRowRenderEventArgs args)
    {
        // var item = args.Item as WorkOrder;

        // args.Class += "state-" + item?.StateColor.TrimStart('#')+
        // " tooltip-target";

    }


    private MarkupString RenderStatesStyle(List<WorkOrder> orders)
    {
        var uniqueColors = orders
           .Select(o => o.StateColor)
           .Where(c => !string.IsNullOrWhiteSpace(c))
           .Distinct();

        var sb = new StringBuilder();
        sb.AppendLine("<style>");
        foreach (var color in uniqueColors)
        {
            var safeName = color.TrimStart('#');
            switch (safeName.ToLowerInvariant())
            {
                case "lime":
                    safeName = "LightGreen";
                    break;
                case "red":
                    safeName = "LightCoral";
                    break;
                case "yellow":
                    safeName = "LightYellow";
                    break;
                default:
                    break;
            }
            sb.AppendLine($".state-{color} {{");
            sb.AppendLine($"    background-color: {safeName};");
            sb.AppendLine("}");
        }
        sb.AppendLine("</style>");

        return new MarkupString(sb.ToString());
    }
    #endregion
}
